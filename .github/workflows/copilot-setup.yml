name: Copilot Workspace Setup

on:
  # Run when a new Copilot Workspace session is created
  workflow_dispatch:
  # Also run on push to ensure dependencies are always ready
  push:
    branches:
      - 'copilot/**'

permissions:
  contents: read

jobs:
  setup:
    name: Setup Copilot Workspace Environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install dependencies
        run: npm ci

      - name: Verify Playwright installation
        run: |
          npx playwright --version
          echo "Playwright installed successfully"

      - name: Setup environment files
        run: |
          # Create frontend environment file if it doesn't exist
          if [ ! -f frontend/.env ]; then
            cp frontend/.env.example frontend/.env
            echo "Created frontend/.env from example"
          fi
          
          # Create API local settings if they don't exist
          if [ ! -f api/local.settings.json ]; then
            cp api/local.settings.json.example api/local.settings.json
            echo "Created api/local.settings.json from example"
          fi

      - name: Build frontend
        run: npm run build:frontend

      - name: Build API
        run: npm run build:api

      - name: Run quick smoke tests
        run: |
          # Start frontend dev server in background
          cd frontend && npm run dev &
          FRONTEND_PID=$!
          
          # Wait for server to be ready
          echo "Waiting for frontend server..."
          timeout 60 bash -c 'until curl -f http://localhost:5173 > /dev/null 2>&1; do sleep 1; done'
          
          # Run quick smoke test
          cd ..
          npx playwright test tests/grocery-list.spec.ts --grep "Smoke test" --project=chromium
          
          # Kill frontend server
          kill $FRONTEND_PID || true

      - name: Setup complete
        run: |
          echo "âœ… Copilot Workspace setup complete!"
          echo ""
          echo "ðŸ“‹ Next steps:"
          echo "  â€¢ Run 'npm run dev' to start the development servers"
          echo "  â€¢ Run 'npm test' to execute all Playwright tests"
          echo "  â€¢ Run 'npm run test:ui' for interactive test debugging"
          echo ""
          echo "ðŸ“š Documentation:"
          echo "  â€¢ docs/copilot-workspace.md - Copilot Workspace guide"
          echo "  â€¢ docs/development.md - Development setup"
          echo "  â€¢ README.md - Quick reference"
