name: Playwright Tests

on:
  workflow_call:
    inputs:
      deployment_url:
        description: 'URL to test'
        required: true
        type: string
      branch_name:
        description: 'Branch name to checkout and test'
        required: false
        type: string
        default: ''
      test_files:
        description: 'Space-separated list of Playwright spec files to run; runs all when empty'
        required: false
        type: string
        default: ''
  workflow_dispatch:
    inputs:
      deployment_url:
        description: 'URL to test'
        required: true
        type: string
      branch_name:
        description: 'Branch name to checkout and test'
        required: true
        type: string
      test_files:
        description: 'Space-separated list of Playwright spec files to run; runs all when empty'
        required: false
        type: string
        default: ''

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Playwright Tests
    steps:
      - name: Checkout code (default)
        if: inputs.branch_name == ''
        uses: actions/checkout@v4

      - name: Check if branch exists
        if: inputs.branch_name != ''
        id: check_branch
        run: |
          echo "Checking if branch '${{ inputs.branch_name }}' exists..."
          
          # Fetch all branches from remote
          git ls-remote --heads origin "${{ inputs.branch_name }}" > /dev/null 2>&1
          
          if [ $? -eq 0 ]; then
            echo "Branch '${{ inputs.branch_name }}' exists"
            echo "branch_exists=true" >> $GITHUB_OUTPUT
          else
            echo "::error::Branch '${{ inputs.branch_name }}' does not exist in the repository"
            echo "branch_exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Checkout specified branch
        if: inputs.branch_name != '' && steps.check_branch.outputs.branch_exists == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch_name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        # This repo's postinstall runs `dotnet restore` for the API.
        # For E2E tests against a deployed URL we don't need the API restored/built,
        # and skipping scripts avoids requiring .NET in this workflow.
        run: npm ci --ignore-scripts

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Run Playwright tests
        env:
          BASE_URL: ${{ inputs.deployment_url }}
          CI: true
        run: |
          echo "Running Playwright tests against: ${{ inputs.deployment_url }}"
          if [ -n "${{ inputs.test_files }}" ]; then
            echo "Running specified test files: ${{ inputs.test_files }}"
            npx playwright test --project=chromium ${{ inputs.test_files }}
          else
            echo "No test files specified; running full suite."
            npx playwright test --project=chromium
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload test traces
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces
          path: test-results/
          retention-days: 7
          if-no-files-found: ignore
