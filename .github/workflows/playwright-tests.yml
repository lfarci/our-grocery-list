name: Playwright Tests

on:
  workflow_call:
    inputs:
      deployment_url:
        description: 'URL to test'
        required: true
        type: string
      branch_name:
        description: 'Branch name to checkout and test'
        required: false
        type: string
        default: ''
  workflow_dispatch:
    inputs:
      deployment_url:
        description: 'URL to test'
        required: true
        type: string
      branch_name:
        description: 'Branch name to checkout and test'
        required: true
        type: string

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Playwright Tests
    steps:
      - name: Checkout code (default)
        if: inputs.branch_name == ''
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if branch exists
        if: inputs.branch_name != ''
        id: check_branch
        run: |
          echo "Checking if branch '${{ inputs.branch_name }}' exists..."
          
          # Fetch all branches from remote
          git ls-remote --heads origin "${{ inputs.branch_name }}" > /dev/null 2>&1
          
          if [ $? -eq 0 ]; then
            echo "Branch '${{ inputs.branch_name }}' exists"
            echo "branch_exists=true" >> $GITHUB_OUTPUT
          else
            echo "::error::Branch '${{ inputs.branch_name }}' does not exist in the repository"
            echo "branch_exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Checkout specified branch
        if: inputs.branch_name != '' && steps.check_branch.outputs.branch_exists == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch_name }}
          fetch-depth: 0

      - name: Determine base ref
        id: base_ref
        run: |
          if [ -n "${{ github.event.pull_request.base.sha }}" ]; then
            echo "base=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_OUTPUT"
          else
            echo "base=origin/main" >> "$GITHUB_OUTPUT"
          fi

      - name: Detect changed Playwright tests
        id: changed_tests
        run: |
          BASE="${{ steps.base_ref.outputs.base }}"

          if [[ "${BASE}" == origin/* ]]; then
            git fetch origin "${BASE#origin/}" --depth=1
            BASE_SHA="$(git rev-parse FETCH_HEAD)"
          else
            BASE_SHA="${BASE}"
          fi

          git diff --name-only "${BASE_SHA}"...HEAD -- 'tests/**/*.spec.ts' > /tmp/changed_tests.txt || true
          COUNT=$(grep -c '' /tmp/changed_tests.txt || true)

          echo "Changed tests (${COUNT}):"
          cat /tmp/changed_tests.txt || true

          echo "count=${COUNT}" >> "$GITHUB_OUTPUT"
          FILE_LIST="$(tr '\n' ' ' < /tmp/changed_tests.txt | sed 's/[[:space:]]*$//')"
          echo "file_list=${FILE_LIST}" >> "$GITHUB_OUTPUT"

      - name: Skip tests (no changes)
        if: steps.changed_tests.outputs.count == '0'
        run: echo "No Playwright test files changed; skipping Playwright run."

      - name: Setup Node.js
        if: steps.changed_tests.outputs.count != '0'
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        if: steps.changed_tests.outputs.count != '0'
        # This repo's postinstall runs `dotnet restore` for the API.
        # For E2E tests against a deployed URL we don't need the API restored/built,
        # and skipping scripts avoids requiring .NET in this workflow.
        run: npm ci --ignore-scripts

      - name: Install Playwright browsers
        if: steps.changed_tests.outputs.count != '0'
        run: npx playwright install chromium --with-deps

      - name: Run Playwright tests
        if: steps.changed_tests.outputs.count != '0'
        env:
          BASE_URL: ${{ inputs.deployment_url }}
          CI: true
        run: |
          echo "Running Playwright tests against: ${{ inputs.deployment_url }}"
          npx playwright test --project=chromium ${{ steps.changed_tests.outputs.file_list }}

      - name: Upload test results
        if: steps.changed_tests.outputs.count != '0' && always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload test traces
        if: steps.changed_tests.outputs.count != '0' && always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces
          path: test-results/
          retention-days: 7
          if-no-files-found: ignore
