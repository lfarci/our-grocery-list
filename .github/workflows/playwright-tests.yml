name: Playwright Tests

on:
  workflow_call:
    inputs:
      deployment_url:
        description: 'URL to test'
        required: true
        type: string
      branch_name:
        description: 'Branch name to checkout and test'
        required: false
        type: string
        default: ''
      test_files:
        description: 'Space-separated list of Playwright spec files to run; runs all when empty'
        required: false
        type: string
        default: ''
  workflow_dispatch:
    inputs:
      deployment_url:
        description: 'URL to test'
        required: true
        type: string
      branch_name:
        description: 'Branch name to checkout and test'
        required: true
        type: string
      test_files:
        description: 'Space-separated list of Playwright spec files to run; runs all when empty'
        required: false
        type: string
        default: ''

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Playwright Tests
    steps:
      - name: Checkout code (default)
        if: inputs.branch_name == ''
        uses: actions/checkout@v4

      - name: Validate branch name
        if: inputs.branch_name != ''
        env:
          BRANCH_NAME: ${{ inputs.branch_name }}
        run: |
          if ! git check-ref-format --branch "$BRANCH_NAME"; then
            echo "::error::Invalid branch name input."
            exit 1
          fi

      - name: Check if branch exists
        if: inputs.branch_name != ''
        id: check_branch
        env:
          BRANCH_NAME: ${{ inputs.branch_name }}
        run: |
          echo "Checking if branch '$BRANCH_NAME' exists..."
          
          # Fetch all branches from remote
          git ls-remote --heads origin "$BRANCH_NAME" > /dev/null 2>&1
          
          if [ $? -eq 0 ]; then
            echo "Branch '$BRANCH_NAME' exists"
            echo "branch_exists=true" >> $GITHUB_OUTPUT
          else
            echo "::error::Branch '$BRANCH_NAME' does not exist in the repository"
            echo "branch_exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Checkout specified branch
        if: inputs.branch_name != '' && steps.check_branch.outputs.branch_exists == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch_name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Setup .NET SDK
        if: inputs.deployment_url == 'local'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install dependencies (remote)
        if: inputs.deployment_url != 'local'
        # This repo's postinstall runs `dotnet restore` for the API.
        # For E2E tests against a deployed URL we don't need the API restored/built,
        # and skipping scripts avoids requiring .NET in this workflow.
        run: npm ci --ignore-scripts

      - name: Install dependencies (local)
        if: inputs.deployment_url == 'local'
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Azure Functions Core Tools
        if: inputs.deployment_url == 'local'
        run: npm install -g azure-functions-core-tools@4 --unsafe-perm true

      - name: Resolve Cosmos connection string
        if: inputs.deployment_url == 'local'
        id: cosmos
        run: |
          connection_string="AccountEndpoint=https://localhost:8081/;AccountKey=C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw=="

          echo "connection_string=${connection_string}" >> "$GITHUB_OUTPUT"

      - name: Start local services
        if: inputs.deployment_url == 'local'
        id: local-services
        uses: ./.github/actions/start-local-services
        with:
          cosmos_connection_string: ${{ steps.cosmos.outputs.connection_string }}

      - name: Run Playwright tests
        env:
          BASE_URL: ${{ inputs.deployment_url == 'local' && steps.local-services.outputs.base_url || inputs.deployment_url }}
          CI: true
          TEST_FILES: ${{ inputs.test_files }}
        run: |
          if [ "${{ inputs.deployment_url }}" = "local" ]; then
            echo "Running Playwright tests against local services."
          else
            echo "Running Playwright tests against: ${{ inputs.deployment_url }}"
          fi
          if [ -n "${TEST_FILES}" ]; then
            echo "Running specified test files: ${TEST_FILES}"
            read -r -a files <<< "${TEST_FILES}"
            for file in "${files[@]}"; do
              if ! [[ "${file}" =~ ^[A-Za-z0-9_./-]+\\.spec\\.ts$ ]]; then
                echo "::error::Invalid test file input: ${file}"
                exit 1
              fi
            done
            npx playwright test --project=chromium "${files[@]}"
          else
            echo "No test files specified; running full suite."
            npx playwright test --project=chromium
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload test traces
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces
          path: test-results/
          retention-days: 7
          if-no-files-found: ignore
